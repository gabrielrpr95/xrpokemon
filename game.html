<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>XRPokémon - Lobby</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <script src="https://xumm.app/assets/cdn/xumm.min.js"></script>
  <style>
    /* ... (mantive seu CSS completo sem alteração) ... */
  </style>
</head>
<body>
  <a href="#" id="connect-wallet" class="cta-button">Connect Wallet</a>

  <div id="lobby" class="container section">
    <h1>XRPokemon - Battle Arena (BETA 1.0)</h1>
    <p>Open your room to wait for another XRPokemon Trainer.<br>
       The fixed cost to open or join the room is <strong>1.0 XRP</strong>.</p>
    <div class="room-form">
      <a href="#" id="create-room" class="cta-button">Open lobby</a>
    </div>

    <div class="lobbies-box">
      <h2>Available Lobbies</h2>
      <div class="lobby-entry"><span>Lobby 1 - 1.0 XRP</span><a href="#" class="cta-button join-btn">Go!</a></div>
      <div class="lobby-entry"><span>Lobby 2 - 1.0 XRP</span><a href="#" class="cta-button join-btn">Go!</a></div>
      <div class="lobby-entry"><span>Lobby 3 - 1.0 XRP</span><a href="#" class="cta-button join-btn">Go!</a></div>
    </div>

    <div id="nft-selector" style="margin-top: 40px;">
      <h2 style="color: var(--pokemon-red); text-shadow: 2px 2px 0 var(--pokemon-blue); font-size: 1.8rem;">Your XRPokémon NFTs</h2>
      <div id="user-nft-grid" class="nft-grid" style="flex-direction: row; flex-wrap: wrap; justify-content: center;"></div>
    </div>
  </div>

  <div id="game" class="container section" style="display: none;">
    <h1>XRPokemon Battlearena</h1>
    <p>Welcome to the battle room! Wait for another trainer or start your battle!</p>
    <div class="battle-container">
      <div class="trainer" id="trainer1"><h2>Trainer 1</h2><div class="nft-grid" id="nft-grid-1"></div></div>
      <div class="vs">VS</div>
      <div class="trainer" id="trainer2"><h2>Trainer 2</h2><div class="nft-grid" id="nft-grid-2"></div></div>
    </div>
    <div style="margin-top: 30px;"><a href="#" id="battle-button" class="cta-button disabled">Battle!</a></div>
    <div id="battle-result"></div>

    <div class="rules-box collapsible">
      <div class="collapsible-header"><h2>Game Rules</h2><span class="toggle-icon">[+]</span></div>
      <div class="box-content">
        <p>1. Each trainer may use only one NFT per battle.</p>
        <p>2. NFTs must be obtained by connecting your XRP wallet.</p>
        <p>3. The winner is determined probabilistically based on NFT attributes.</p>
        <p>4. In case of a tie, the winner is chosen at random.</p>
        <p>5. This game is for entertainment; rules may be updated.</p>
      </div>
    </div>

    <div class="ranking-box collapsible">
      <div class="collapsible-header"><h2>Leaderboard</h2><span class="toggle-icon">[+]</span></div>
      <div class="box-content">
        <p>• Each NFT has attributes (attack, defense, HP) that determine its score.</p>
        <p>• Total score is calculated by multiplying the sum of attributes by the NFT's rarity.</p>
        <p>• During battle, the chance of victory is based on this score.</p>
        <p>• In case of a tie, the winner is chosen randomly.</p>
        <p>• The leaderboard is based on the quality and number of winning NFTs over time.</p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let userToken = null;
      let userAddress = null;
      const connectWalletBtn = document.getElementById("connect-wallet");
      const nftGrid1 = document.getElementById('nft-grid-1');
      const nftGrid2 = document.getElementById('nft-grid-2');
      const battleButton = document.getElementById('battle-button');
      const battleResult = document.getElementById('battle-result');
      let selection1 = null;
      let selection2 = null;

      function checkExistingConnection() {
        const savedToken = localStorage.getItem('xummUserToken');
        const savedAddress = localStorage.getItem('xummWalletAddress');
        if (savedToken && savedAddress) {
          userToken = savedToken;
          userAddress = savedAddress;
          connectWalletBtn.textContent = "Carteira Conectada";
          return true;
        }
        return false;
      }

      async function connectXummWallet() {
        try {
          connectWalletBtn.classList.add('disabled');
          connectWalletBtn.textContent = "Conectando...";
          const xumm = new Xumm("46c2e7c6-c005-4a6d-bef7-e0b6090bc9bd");
          const auth = await xumm.authorize();
          if (auth && auth.me && auth.me.account) {
            userToken = auth.token || "";
            userAddress = auth.me.account;
            localStorage.setItem('xummUserToken', userToken);
            localStorage.setItem('xummWalletAddress', userAddress);
            connectWalletBtn.textContent = "Carteira Conectada";
            alert("Carteira conectada! Endereço: " + userAddress);
            loadUserNFTs();
            return true;
          } else {
            alert("Falha na conexão. Tente novamente.");
            return false;
          }
        } catch (error) {
          console.error(error);
          alert("Erro ao conectar: " + error.message);
          return false;
        } finally {
          connectWalletBtn.classList.remove('disabled');
          connectWalletBtn.textContent = userAddress ? "Carteira Conectada" : "Connect Wallet";
        }
      }

      connectWalletBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        if (userToken && userAddress) {
          userToken = null;
          userAddress = null;
          localStorage.removeItem('xummUserToken');
          localStorage.removeItem('xummWalletAddress');
          connectWalletBtn.textContent = "Connect Wallet";
          alert("Carteira desconectada!");
        } else {
          await connectXummWallet();
        }
      });

      function simulateNFTInsertion(grid, contentHTML) {
        const nftElement = document.createElement('div');
        nftElement.classList.add('nft');
        nftElement.innerHTML = contentHTML;
        grid.appendChild(nftElement);

        nftElement.addEventListener('click', () => {
          const isGrid1 = grid.id === 'nft-grid-1';
          const selection = isGrid1 ? selection1 : selection2;
          const gridRef = isGrid1 ? nftGrid1 : nftGrid2;

          if (selection === nftElement) {
            if (isGrid1) selection1 = null;
            else selection2 = null;
            nftElement.classList.remove('selected');
          } else {
            Array.from(gridRef.children).forEach(el => el.classList.remove('selected'));
            nftElement.classList.add('selected');
            if (isGrid1) selection1 = nftElement;
            else selection2 = nftElement;
          }

          battleButton.classList.toggle('disabled', !(selection1 && selection2));
        });
      }

      simulateNFTInsertion(nftGrid1, "<strong>Charmander</strong>");
      simulateNFTInsertion(nftGrid1, "<strong>Bulbasaur</strong>");
      simulateNFTInsertion(nftGrid1, "<strong>Squirtle</strong>");
      simulateNFTInsertion(nftGrid2, "<strong>Pikachu</strong>");
      simulateNFTInsertion(nftGrid2, "<strong>Jigglypuff</strong>");
      simulateNFTInsertion(nftGrid2, "<strong>Meowth</strong>");

      battleButton.addEventListener('click', (e) => {
        e.preventDefault();
        if (selection1 && selection2) {
          const winner = Math.random() < 0.5 ? "Treinador 1" : "Treinador 2";
          battleResult.innerHTML = `<p>O vencedor é: ${winner}!</p>`;
          selection1.classList.remove('selected');
          selection2.classList.remove('selected');
          selection1 = null;
          selection2 = null;
          battleButton.classList.add('disabled');
        }
      });

      document.querySelectorAll('.collapsible .collapsible-header').forEach(header => {
        header.addEventListener('click', () => {
          const content = header.nextElementSibling;
          const toggleIcon = header.querySelector('.toggle-icon');
          const isVisible = content.style.display === 'block';
          content.style.display = isVisible ? 'none' : 'block';
          toggleIcon.textContent = isVisible ? '[+]' : '[-]';
        });
      });

      document.getElementById("create-room").addEventListener("click", function(e) {
        e.preventDefault();
        alert("Lobby opened successfully! Cost: 1.0 XRP.");
        document.getElementById("lobby").style.display = "none";
        document.getElementById("game").style.display = "block";
      });

      document.querySelectorAll('.lobby-entry .join-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          alert("You joined the lobby! Cost: 1.0 XRP.");
          document.getElementById("lobby").style.display = "none";
          document.getElementById("game").style.display = "block";
        });
      });

      async function loadUserNFTs() {
        if (!userAddress) return;
        const url = `https://xls20-api.xrpldata.com/account/${userAddress}/nfts`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          const filtered = data.nfts.filter(nft => nft.issuer === 'rPDGG5b2kWQPGSPZCULfUp26t39MrbLxzq');
          const grid = document.getElementById('user-nft-grid');
          grid.innerHTML = '';
          if (filtered.length === 0) {
            grid.innerHTML = '<p style="text-align:center;">Você não possui nenhum XRPokémon NFT ainda.</p>';
            return;
          }
          filtered.forEach(nft => {
            const nftEl = document.createElement('div');
            nftEl.classList.add('nft');
            nftEl.innerHTML = `<img src="${nft.url}" alt="NFT" style="max-height:100px;"><br><strong>${nft.name || 'XRPokémon'}</strong>`;
            grid.appendChild(nftEl);
          });
        } catch (err) {
          console.error("Erro ao buscar NFTs:", err);
          document.getElementById('user-nft-grid').innerHTML = '<p>Erro ao carregar seus NFTs.</p>';
        }
      }

      checkExistingConnection();
    });
  </script>
</body>
</html>
